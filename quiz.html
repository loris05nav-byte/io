<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizProf - Application Compl√®te (JS Pur)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* S'assurer que les vues masqu√©es ne sont pas visibles */
        [data-view]:not(.active) {
            display: none;
        }
        /* Style des ic√¥nes pour simuler Lucide Icons */
        .icon-sm { width: 1.125rem; height: 1.125rem; vertical-align: middle; }
        .icon-md { width: 1.5rem; height: 1.5rem; vertical-align: middle; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="app-container">
        
        <section data-view="login" class="active min-h-screen bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center p-6">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-purple-600 mb-2">üìö QuizProf</h1>
                    <p class="text-gray-600">Plateforme de quiz √©ducatifs</p>
                </div>

                <div class="flex gap-2 mb-6" id="user-type-selector">
                    <button data-type="teacher" class="flex-1 py-3 rounded-lg font-semibold transition bg-purple-600 text-white">
                        üë®‚Äçüè´ Professeur
                    </button>
                    <button data-type="student" class="flex-1 py-3 rounded-lg font-semibold transition bg-gray-100 text-gray-600">
                        üéì √âl√®ve
                    </button>
                </div>
                
                <div id="auth-error-message" class="hidden p-3 bg-red-100 text-red-700 rounded-lg font-semibold mb-4"></div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Email (D√©mo: n'importe quel email)</label>
                        <input type="email" id="login-email" placeholder="votre.email@exemple.com" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"/>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Mot de passe (D√©mo: n'importe quel mot de passe)</label>
                        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"/>
                    </div>

                    <button id="login-btn" class="w-full py-4 rounded-xl font-semibold text-white transition bg-purple-600 hover:bg-purple-700">
                        Se connecter
                    </button>

                    <button id="guest-login-btn" class="w-full py-3 rounded-xl font-semibold bg-gray-200 hover:bg-gray-300 text-gray-700 transition">
                        Continuer en tant que Visiteur
                    </button>
                </div>
            </div>
        </section>

        <section data-view="list" class="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50">
            <div id="navbar-teacher"></div>
            <div class="max-w-6xl mx-auto p-6">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Mes Quiz</h2>
                    
                    <button id="create-quiz-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-4 px-6 rounded-xl flex items-center justify-center gap-2 transition mb-6">
                        <svg class="icon-md" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> 
                        Cr√©er un nouveau quiz
                    </button>

                    <div id="teacher-quiz-list" class="space-y-4">
                        </div>
                </div>
            </div>
        </section>

        <section data-view="create" class="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50">
            <header class="bg-white shadow-md">
                <div class="max-w-6xl mx-auto px-6 py-4">
                    <button id="cancel-create-btn-top" class="text-purple-600 hover:text-purple-700 font-semibold">
                        ‚Üê Retour aux quiz
                    </button>
                </div>
            </header>
            <div class="max-w-4xl mx-auto p-6">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h1 class="text-3xl font-bold text-purple-600 mb-6">Cr√©er un nouveau quiz</h1>

                    <div class="space-y-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Titre du quiz *</label>
                            <input type="text" id="quiz-title" placeholder="Ex: Les capitales europ√©ennes" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"/>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Description (optionnel)</label>
                            <textarea id="quiz-description" placeholder="D√©crivez votre quiz..." rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"></textarea>
                        </div>

                        <hr class="my-8" />

                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Questions</h2>

                        <div id="questions-container">
                            </div>

                        <button id="add-question-btn" class="w-full border-2 border-dashed border-purple-300 hover:border-purple-500 text-purple-600 font-semibold py-4 px-6 rounded-xl flex items-center justify-center gap-2 transition">
                            <svg class="icon-md" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Ajouter une question
                        </button>

                        <div class="flex gap-4 pt-6">
                            <button id="save-quiz-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-4 px-6 rounded-xl flex items-center justify-center gap-2 transition">
                                <svg class="icon-md" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> 
                                Enregistrer le quiz
                            </button>
                            <button id="cancel-create-btn-bottom" class="px-6 py-4 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition">
                                Annuler
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section data-view="student-dashboard" class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50">
            <div id="navbar-student"></div>
            <div class="max-w-6xl mx-auto p-6">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Quiz disponibles</h2>
                    
                    <div id="student-quiz-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>
            </div>
        </section>
        
        <section data-view="student-history" class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50">
            <div id="navbar-history"></div>
            <div class="max-w-6xl mx-auto p-6">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <svg class="icon-md text-yellow-500" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 11h.01"></path><path d="M18 11h.01"></path><path d="M6 11h.01"></path><path d="M12 18h.01"></path><path d="M6 18h.01"></path><path d="M18 18h.01"></path><path d="M3 4h18v16H3z"></path></svg>
                        Mon Historique de Quiz
                    </h2>
                    <div id="history-table-container" class="overflow-x-auto">
                        </div>
                </div>
            </div>
        </section>

        <section data-view="playing" class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50">
            <header class="bg-white shadow-md">
                <div class="max-w-4xl mx-auto px-6 py-4">
                    <div class="flex justify-between items-center">
                        <h2 id="playing-quiz-title" class="text-xl font-bold text-gray-800"></h2>
                        <span id="question-index-display" class="text-gray-600"></span>
                    </div>
                    <div class="mt-3 bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
            </header>

            <div class="max-w-4xl mx-auto p-6">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 id="current-question-text" class="text-2xl font-bold text-gray-800 mb-6"></h3>

                    <div id="multiple-answers-hint" class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <p class="text-blue-800 font-semibold">‚ÑπÔ∏è Plusieurs r√©ponses possibles</p>
                    </div>

                    <div id="answers-container" class="space-y-3">
                        </div>

                    <div class="flex gap-4 mt-8">
                        <button id="prev-question-btn" class="px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition">
                            ‚Üê Pr√©c√©dent
                        </button>
                        <button id="next-question-btn" class="flex-1 py-3 rounded-xl font-semibold transition bg-blue-600 hover:bg-blue-700 text-white" disabled>
                            Suivant ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <section data-view="finished" class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center p-6">
            <div class="bg-white rounded-2xl shadow-2xl p-12 max-w-2xl w-full text-center">
                <div id="finish-icon" class="text-6xl mb-6"></div>
                <h2 class="text-4xl font-bold text-gray-800 mb-4">Quiz termin√© !</h2>
                <div id="final-score-display" class="text-6xl font-bold text-blue-600 mb-6"></div>
                <p id="final-percentage-display" class="text-2xl text-gray-600 mb-8"></p>
                <div class="flex gap-4">
                    <button id="finish-return-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-xl transition">
                        Retour au tableau de bord
                    </button>
                    <button id="finish-restart-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-6 rounded-xl transition">
                        Recommencer
                    </button>
                </div>
            </div>
        </section>

    </div>

    <script>
        // --- √âTATS GLOBALES ---
        let currentUser = null;
        let quizzes = [];
        let studentScores = [];
        let currentView = 'login';
        
        let quizForm = {
            title: '',
            description: '',
            questions: [{
                question: '',
                answers: ['', '', '', ''],
                correctAnswers: [0],
                multipleAnswers: false
            }]
        };

        // √âtats du mode jeu
        let playingQuiz = null;
        let currentQuestionIndex = 0;
        let studentAnswers = [];
        let finalScore = 0;
        let finalTotal = 0;

        // --- FONCTIONS UTILITAIRES DE PERSISTENCE (localStorage) ---

        const loadData = (key, defaultValue) => {
            try {
                const storedData = localStorage.getItem(key);
                return storedData ? JSON.parse(storedData) : defaultValue;
            } catch (e) {
                console.error(`Error loading data for key ${key}:`, e);
                return defaultValue;
            }
        };

        const saveData = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving data for key ${key}:`, e);
            }
        };

        const initializeData = () => {
            currentUser = loadData('quizprof_user', null);
            quizzes = loadData('quizprof_quizzes', []);
            studentScores = loadData('quizprof_scores', []);
            
            if (currentUser && currentUser.type) {
                currentView = currentUser.type === 'teacher' ? 'list' : 'student-dashboard';
            } else {
                currentView = 'login';
            }
            renderApp();
        };

        // --- GESTION DE LA VUE ET DU RENDU ---

        const navigateTo = (view) => {
            currentView = view;
            saveData('quizprof_user', currentUser);
            renderApp();
        };

        const renderApp = () => {
            document.querySelectorAll('[data-view]').forEach(section => {
                section.classList.remove('active');
            });
            const activeView = document.querySelector(`[data-view="${currentView}"]`);
            if (activeView) {
                activeView.classList.add('active');
            }
            
            // Rendu des vues sp√©cifiques
            if (currentUser) {
                renderNavBar();
            }
            if (currentView === 'list') renderTeacherQuizList();
            if (currentView === 'create') renderQuizForm();
            if (currentView === 'student-dashboard') renderStudentDashboard();
            if (currentView === 'student-history') renderStudentHistory();
            if (currentView === 'playing') renderPlayingView();
            if (currentView === 'finished') renderFinishedView();
        };
        
        // --- VUES PARTIELLES ---

        const getIconSVG = (name, size = 20) => {
            const icons = {
                'LogOut': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`,
                'Layers': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12.835 2.164-9 11A2 2 0 0 0 3 14v6a2 2 0 0 0 2 2h6a2 2 0 0 0 1.933-1.578l9-11A2 2 0 0 0 21 9V3a2 2 0 0 0-2-2h-6a2 2 0 0 0-2.165 1.164z"></path><path d="m18 10-6 7-6-7"></path></svg>`,
                'Plus': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
                'Play': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`,
                'Trash2': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
                'Award': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"></circle><path d="M8.2 14.2 12 18l3.8-3.8"></path><path d="M12 18v6"></path></svg>`,
                'Home': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
                'Check': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
            };
            return icons[name] || '';
        };

        const renderNavBar = () => {
            const isTeacher = currentUser.type === 'teacher';
            const isStudent = currentUser.type === 'student';
            const isGuest = currentUser.type === 'guest';
            
            const color = isTeacher ? 'purple' : 'blue';
            const bgColor = isTeacher ? 'bg-purple-500 text-white' : 'bg-blue-500 text-white';
            const textColor = isTeacher ? 'text-purple-600' : 'text-blue-600';
            const hoverClass = isTeacher ? 'hover:bg-purple-50' : 'hover:bg-blue-50';

            const userRoleText = isTeacher ? 'Professeur' : isStudent ? '√âl√®ve' : 'Visiteur';
            const userRoleBg = isTeacher ? 'bg-purple-100 text-purple-700' : isStudent ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700';

            const navHTML = `
                <div class="bg-white shadow-md">
                    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <h1 class="text-2xl font-bold ${textColor}">üìö QuizProf</h1>
                            <span class="px-3 py-1 ${userRoleBg} rounded-full text-sm font-semibold">
                                ${userRoleText}
                            </span>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            ${isTeacher ? `
                                <button data-nav="list" class="flex items-center gap-2 px-4 py-2 rounded-lg transition ${currentView === 'list' ? `${bgColor}` : `${hoverClass} text-gray-600`}">
                                    ${getIconSVG('Layers', 18)} Mes Quiz
                                </button>
                            ` : ''}

                            ${(isStudent || isGuest) ? `
                                <button data-nav="student-dashboard" class="flex items-center gap-2 px-4 py-2 rounded-lg transition ${currentView === 'student-dashboard' ? `${bgColor}` : `${hoverClass} text-gray-600`}">
                                    ${getIconSVG('Home', 18)} Quiz
                                </button>
                            ` : ''}
                            
                            ${isStudent ? `
                                <button data-nav="student-history" class="flex items-center gap-2 px-4 py-2 rounded-lg transition ${currentView === 'student-history' ? `${bgColor}` : `${hoverClass} text-gray-600`}">
                                    ${getIconSVG('Award', 18)} Historique
                                </button>
                            ` : ''}
                            
                            <span class="text-gray-600">üëã ${currentUser.name}</span>
                            <button id="logout-btn" class="flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">
                                ${getIconSVG('LogOut', 18)}
                                D√©connexion
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // On met la NavBar dans toutes les sections qui peuvent l'utiliser
            document.getElementById('navbar-teacher').innerHTML = navHTML;
            document.getElementById('navbar-student').innerHTML = navHTML;
            document.getElementById('navbar-history').innerHTML = navHTML;

            // Attacher les √©couteurs d'√©v√©nements (d√©l√©gu√©s)
            document.querySelectorAll('[data-nav]').forEach(btn => {
                btn.onclick = () => navigateTo(btn.getAttribute('data-nav'));
            });
            document.getElementById('logout-btn').onclick = handleLogout;
        };

        const renderTeacherQuizList = () => {
            const listContainer = document.getElementById('teacher-quiz-list');
            const teacherQuizzes = quizzes.filter(q => q.createdBy === currentUser.name);

            if (teacherQuizzes.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <p class="text-xl">Aucun quiz pour le moment</p>
                        <p class="text-sm mt-2">Cr√©ez votre premier quiz pour commencer !</p>
                    </div>
                `;
            } else {
                listContainer.innerHTML = teacherQuizzes.map(quiz => `
                    <div class="border-2 border-gray-200 rounded-xl p-5 hover:border-purple-300 transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800">${quiz.title}</h3>
                                ${quiz.description ? `<p class="text-gray-600 mt-1">${quiz.description}</p>` : ''}
                                <div class="flex gap-4 mt-3 text-sm text-gray-500">
                                    <span>üìù ${quiz.questions.length} question${quiz.questions.length > 1 ? 's' : ''}</span>
                                    <span>üìÖ ${quiz.createdAt}</span>
                                </div>
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button data-quiz-id="${quiz.id}" data-action="preview" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition font-semibold flex items-center gap-1">
                                    ${getIconSVG('Play', 16)} Pr√©visualiser
                                </button>
                                <button data-quiz-id="${quiz.id}" data-action="delete" class="bg-red-500 hover:bg-red-600 text-white p-3 rounded-lg transition" title="Supprimer">
                                    ${getIconSVG('Trash2', 20)}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Attacher les √©couteurs d'√©v√©nements
                document.querySelectorAll('#teacher-quiz-list button').forEach(btn => {
                    const quizId = parseInt(btn.getAttribute('data-quiz-id'));
                    const action = btn.getAttribute('data-action');
                    const quiz = quizzes.find(q => q.id === quizId);
                    if (action === 'preview') {
                        btn.onclick = () => startQuiz(quiz);
                    } else if (action === 'delete') {
                        btn.onclick = () => deleteQuiz(quizId);
                    }
                });
            }
        };

        const renderQuizForm = () => {
            document.getElementById('quiz-title').value = quizForm.title;
            document.getElementById('quiz-description').value = quizForm.description;

            const container = document.getElementById('questions-container');
            container.innerHTML = quizForm.questions.map((q, qIndex) => {
                const answersHTML = q.answers.map((answer, aIndex) => {
                    const isCorrect = q.correctAnswers.includes(aIndex);
                    return `
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="correct-${qIndex}-${aIndex}" data-q-index="${qIndex}" data-a-index="${aIndex}" ${isCorrect ? 'checked' : ''} onchange="toggleCorrectAnswer(event)" class="w-5 h-5 text-purple-600"/>
                            <input type="text" value="${answer}" data-q-index="${qIndex}" data-a-index="${aIndex}" oninput="updateAnswer(event)" placeholder="R√©ponse ${aIndex + 1}" class="flex-1 px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none"/>
                            <span class="text-sm font-semibold w-24">
                                ${isCorrect ? '<span class="text-green-600">‚úì Correcte</span>' : ''}
                            </span>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="border-2 border-purple-200 rounded-xl p-6 bg-purple-50">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Question ${qIndex + 1}</h3>
                            ${quizForm.questions.length > 1 ? `<button onclick="deleteQuestion(${qIndex})" class="text-red-500 hover:text-red-700">${getIconSVG('Trash2', 20)}</button>` : ''}
                        </div>

                        <input type="text" value="${q.question}" data-q-index="${qIndex}" data-field="question" oninput="updateQuestion(event)" placeholder="Votre question..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none mb-4"/>

                        <div class="mb-4 flex items-center gap-3 bg-white p-3 rounded-lg">
                            <input type="checkbox" id="multi-q-${qIndex}" data-q-index="${qIndex}" data-field="multipleAnswers" ${q.multipleAnswers ? 'checked' : ''} onchange="updateQuestion(event)" class="w-5 h-5 text-purple-600"/>
                            <label for="multi-q-${qIndex}" class="font-semibold text-gray-700 cursor-pointer">
                                Plusieurs r√©ponses correctes possibles
                            </label>
                        </div>

                        <div class="space-y-3">
                            <p class="font-semibold text-gray-700 text-sm">R√©ponses :</p>
                            ${answersHTML}
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        const renderStudentDashboard = () => {
            const listContainer = document.getElementById('student-quiz-list');
            const availableQuizzes = quizzes;

            if (availableQuizzes.length === 0) {
                listContainer.innerHTML = `
                    <div class="md:col-span-2 text-center py-12 text-gray-400">
                        <p class="text-xl">Aucun quiz disponible pour le moment</p>
                        <p class="text-sm mt-2">Veuillez revenir plus tard.</p>
                    </div>
                `;
            } else {
                listContainer.innerHTML = availableQuizzes.map(quiz => `
                    <div class="border-2 border-blue-200 rounded-xl p-6 hover:border-blue-400 transition bg-gradient-to-br from-blue-50 to-white flex flex-col justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${quiz.title}</h3>
                            ${quiz.description ? `<p class="text-gray-600 mb-4 text-sm">${quiz.description}</p>` : ''}
                        </div>
                        <div>
                            <span class="text-sm text-gray-500 block mb-3">üìù ${quiz.questions.length} question${quiz.questions.length > 1 ? 's' : ''}</span>
                            <button data-quiz-id="${quiz.id}" data-action="start-quiz" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition font-semibold flex items-center justify-center gap-2">
                                ${getIconSVG('Play', 18)} Commencer
                            </button>
                        </div>
                    </div>
                `).join('');
                
                document.querySelectorAll('#student-quiz-list button').forEach(btn => {
                    const quizId = parseInt(btn.getAttribute('data-quiz-id'));
                    const quiz = quizzes.find(q => q.id === quizId);
                    btn.onclick = () => startQuiz(quiz);
                });
            }
        };

        const renderStudentHistory = () => {
            const tableContainer = document.getElementById('history-table-container');
            const userHistory = studentScores.filter(s => s.userName === currentUser.name).reverse();

            if (userHistory.length === 0) {
                tableContainer.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <p class="text-xl">Aucun historique trouv√©.</p>
                        <p class="text-sm mt-2">Commencez un quiz pour enregistrer votre premier r√©sultat !</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal border-b">
                            <th class="py-3 px-6 text-left">Quiz</th>
                            <th class="py-3 px-6 text-center">Score</th>
                            <th class="py-3 px-6 text-center">Pourcentage</th>
                            <th class="py-3 px-6 text-center">Date</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 text-sm font-light">
                        ${userHistory.map(score => {
                            const percentage = Math.round((score.score / score.total) * 100);
                            let rowClass = '';
                            if (percentage >= 80) rowClass = 'bg-green-50';
                            else if (percentage >= 50) rowClass = 'bg-yellow-50';
                            
                            const scoreClass = percentage >= 80 ? 'text-green-600' : 'text-orange-600';

                            return `
                                <tr class="border-b border-gray-200 hover:bg-gray-50 ${rowClass}">
                                    <td class="py-3 px-6 text-left whitespace-nowrap font-medium">${score.quizTitle}</td>
                                    <td class="py-3 px-6 text-center">${score.score} / ${score.total}</td>
                                    <td class="py-3 px-6 text-center font-bold ${scoreClass}">
                                        ${percentage}%
                                    </td>
                                    <td class="py-3 px-6 text-center">${score.date.split(' ')[0]}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            tableContainer.innerHTML = tableHTML;
        };
        
        const renderPlayingView = () => {
            if (!playingQuiz) return;

            const currentQ = playingQuiz.questions[currentQuestionIndex];
            const isLastQuestion = currentQuestionIndex === playingQuiz.questions.length - 1;
            const currentAnswer = studentAnswers[currentQuestionIndex] || [];
            
            // Mise √† jour de l'ent√™te
            document.getElementById('playing-quiz-title').textContent = playingQuiz.title;
            document.getElementById('question-index-display').textContent = `Question ${currentQuestionIndex + 1} / ${playingQuiz.questions.length}`;
            document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / playingQuiz.questions.length) * 100}%`;
            
            // Mise √† jour de la question et du hint
            document.getElementById('current-question-text').textContent = currentQ.question;
            document.getElementById('multiple-answers-hint').classList.toggle('hidden', !currentQ.multipleAnswers);
            
            // Mise √† jour des boutons de navigation
            document.getElementById('prev-question-btn').style.display = currentQuestionIndex > 0 ? 'inline-block' : 'none';
            document.getElementById('next-question-btn').textContent = isLastQuestion ? 'Terminer' : 'Suivant ‚Üí';
            document.getElementById('next-question-btn').disabled = currentAnswer.length === 0;

            // Mise √† jour des r√©ponses
            const answersContainer = document.getElementById('answers-container');
            answersContainer.innerHTML = currentQ.answers.map((answer, idx) => {
                const isSelected = currentAnswer.includes(idx);
                
                return `
                    <button data-answer-index="${idx}" 
                        class="w-full p-5 rounded-xl text-left font-semibold transition border-2 flex items-center gap-3 
                        ${isSelected ? 'bg-blue-100 border-blue-500 text-blue-800' : 'bg-gray-50 border-gray-200 hover:border-blue-300'}"
                    >
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'bg-blue-500 border-blue-500' : 'border-gray-300'}">
                            ${isSelected ? getIconSVG('Check', 14) : ''}
                        </div>
                        <span>${answer}</span>
                    </button>
                `;
            }).join('');
            
            // √âcouteurs pour les r√©ponses
            document.querySelectorAll('#answers-container button').forEach(btn => {
                const idx = parseInt(btn.getAttribute('data-answer-index'));
                btn.onclick = () => handleStudentAnswer(idx);
            });
            
            document.getElementById('prev-question-btn').onclick = () => setCurrentQuestionIndex(currentQuestionIndex - 1);
            document.getElementById('next-question-btn').onclick = nextQuestion;
        };

        const renderFinishedView = () => {
            const percentage = Math.round((finalScore / finalTotal) * 100);
            
            document.getElementById('finish-icon').innerHTML = percentage >= 80 ? 'üéâ' : percentage >= 50 ? 'üëç' : 'üí™';
            document.getElementById('final-score-display').textContent = `${finalScore} / ${finalTotal}`;
            document.getElementById('final-percentage-display').textContent = `Score : ${percentage}%`;
            
            document.getElementById('finish-return-btn').onclick = () => {
                const targetView = currentUser.type === 'teacher' ? 'list' : 'student-dashboard';
                navigateTo(targetView);
                playingQuiz = null; // R√©initialiser le quiz en cours
            };
            document.getElementById('finish-restart-btn').onclick = () => startQuiz(playingQuiz);
        };

        // --- LOGIQUE AUTHENTIFICATION ---

        let selectedUserType = 'teacher';

        const setupLoginEvents = () => {
            const selector = document.getElementById('user-type-selector');
            selector.querySelectorAll('button').forEach(btn => {
                btn.onclick = () => {
                    selectedUserType = btn.getAttribute('data-type');
                    selector.querySelectorAll('button').forEach(b => {
                        const isSelected = b.getAttribute('data-type') === selectedUserType;
                        const color = selectedUserType === 'teacher' ? 'purple' : 'blue';
                        b.className = `flex-1 py-3 rounded-lg font-semibold transition ${isSelected ? `bg-${color}-600 text-white` : 'bg-gray-100 text-gray-600'}`;
                    });
                    document.getElementById('login-btn').className = `w-full py-4 rounded-xl font-semibold text-white transition bg-${color}-600 hover:bg-${color}-700`;
                };
            });
            
            document.getElementById('login-btn').onclick = handleLogin;
            document.getElementById('guest-login-btn').onclick = handleGuestLogin;
        };

        const handleLogin = () => {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorElement = document.getElementById('auth-error-message');
            
            if (!email || !password) {
                errorElement.textContent = 'Veuillez remplir tous les champs.';
                errorElement.classList.remove('hidden');
                return;
            }
            
            errorElement.classList.add('hidden');
            
            currentUser = {
                email: email,
                type: selectedUserType,
                name: email.split('@')[0],
            };
            
            navigateTo(selectedUserType === 'teacher' ? 'list' : 'student-dashboard');
        };

        const handleGuestLogin = () => {
            currentUser = {
                name: 'Visiteur',
                type: 'guest',
            };
            navigateTo('student-dashboard');
        };

        const handleLogout = () => {
            currentUser = null;
            navigateTo('login');
        };

        // --- LOGIQUE CR√âATION QUIZ (PROFESSEUR) ---

        const setupCreateQuizEvents = () => {
            document.getElementById('create-quiz-btn').onclick = () => {
                // R√©initialiser le formulaire avant de naviguer
                quizForm = { title: '', description: '', questions: [{ question: '', answers: ['', '', '', ''], correctAnswers: [0], multipleAnswers: false }] };
                navigateTo('create');
            };

            document.getElementById('cancel-create-btn-top').onclick = () => navigateTo('list');
            document.getElementById('cancel-create-btn-bottom').onclick = () => navigateTo('list');
            document.getElementById('add-question-btn').onclick = addQuestion;
            document.getElementById('save-quiz-btn').onclick = saveQuiz;
            
            // Mettre √† jour les donn√©es du formulaire en temps r√©el
            document.getElementById('quiz-title').oninput = (e) => quizForm.title = e.target.value;
            document.getElementById('quiz-description').oninput = (e) => quizForm.description = e.target.value;
        };

        const addQuestion = () => {
            quizForm.questions.push({
                question: '',
                answers: ['', '', '', ''],
                correctAnswers: [0],
                multipleAnswers: false
            });
            renderQuizForm();
        };

        const updateQuestion = (e) => {
            const index = parseInt(e.target.getAttribute('data-q-index'));
            const field = e.target.getAttribute('data-field');
            const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
            
            quizForm.questions[index][field] = value;
            
            if (field === 'multipleAnswers' && !value) {
                // Si on passe √† r√©ponse unique, garder la premi√®re bonne r√©ponse
                quizForm.questions[index].correctAnswers = [quizForm.questions[index].correctAnswers[0] || 0];
            }
            
            renderQuizForm();
        };

        const updateAnswer = (e) => {
            const qIndex = parseInt(e.target.getAttribute('data-q-index'));
            const aIndex = parseInt(e.target.getAttribute('data-a-index'));
            quizForm.questions[qIndex].answers[aIndex] = e.target.value;
        };

        const toggleCorrectAnswer = (e) => {
            const qIndex = parseInt(e.target.getAttribute('data-q-index'));
            const aIndex = parseInt(e.target.getAttribute('data-a-index'));
            const question = quizForm.questions[qIndex];
            
            if (question.multipleAnswers) {
                const idx = question.correctAnswers.indexOf(aIndex);
                if (idx > -1) {
                    question.correctAnswers.splice(idx, 1);
                } else {
                    question.correctAnswers.push(aIndex);
                }
                // S'assurer qu'il y a toujours au moins une r√©ponse coch√©e (sinon le quiz n'est pas valide)
                if (question.correctAnswers.length === 0) {
                    question.correctAnswers.push(aIndex);
                    e.target.checked = true;
                }
            } else {
                question.correctAnswers = [aIndex];
            }
            renderQuizForm();
        };

        const deleteQuestion = (index) => {
            if (quizForm.questions.length === 1) {
                alert("Un quiz doit contenir au moins une question.");
                return;
            }
            quizForm.questions.splice(index, 1);
            renderQuizForm();
        };

        const saveQuiz = () => {
            if (!quizForm.title.trim()) {
                alert('Veuillez donner un titre au quiz.');
                return;
            }
            const validQuestions = quizForm.questions.filter(q => q.question.trim() !== '' && q.answers.every(a => a.trim() !== ''));
            if (validQuestions.length === 0) {
                alert('Veuillez remplir au moins une question avec ses r√©ponses.');
                return;
            }
            
            const newQuiz = {
                id: Date.now(),
                title: quizForm.title.trim(),
                description: quizForm.description.trim(),
                questions: validQuestions,
                createdBy: currentUser.name,
                createdAt: new Date().toLocaleDateString('fr-FR'),
            };
            
            quizzes.push(newQuiz);
            saveData('quizprof_quizzes', quizzes);
            alert('Quiz enregistr√© avec succ√®s !');
            navigateTo('list');
        };

        const deleteQuiz = (id) => {
            if (currentUser.type !== 'teacher') return;
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce quiz ?')) {
                quizzes = quizzes.filter(q => q.id !== id);
                studentScores = studentScores.filter(score => score.quizId !== id);
                saveData('quizprof_quizzes', quizzes);
                saveData('quizprof_scores', studentScores);
                renderTeacherQuizList();
            }
        };


        // --- LOGIQUE MODE JEU (√âL√àVE) ---

        const startQuiz = (quiz) => {
            playingQuiz = quiz;
            currentQuestionIndex = 0;
            // Cr√©er un tableau vide pour stocker les r√©ponses de l'utilisateur pour chaque question
            studentAnswers = Array(quiz.questions.length).fill(null).map(() => []);
            finalScore = 0;
            finalTotal = quiz.questions.length;
            navigateTo('playing');
        };

        const handleStudentAnswer = (answerIndex) => {
            const currentQ = playingQuiz.questions[currentQuestionIndex];
            let currentAns = studentAnswers[currentQuestionIndex] || [];

            if (currentQ.multipleAnswers) {
                const idx = currentAns.indexOf(answerIndex);
                if (idx > -1) {
                    currentAns.splice(idx, 1); // D√©s√©lectionner
                } else {
                    currentAns.push(answerIndex); // S√©lectionner
                }
            } else {
                currentAns = [answerIndex]; // S√©lectionner uniquement celle-ci
            }
            
            studentAnswers[currentQuestionIndex] = currentAns;
            renderPlayingView();
        };

        const nextQuestion = () => {
            if (currentQuestionIndex < playingQuiz.questions.length - 1) {
                currentQuestionIndex++;
                renderPlayingView();
            } else {
                finishQuiz();
            }
        };

        const finishQuiz = () => {
            let correctCount = 0;
            
            playingQuiz.questions.forEach((q, idx) => {
                const studentAns = studentAnswers[idx] || [];
                const correctAns = q.correctAnswers;
                
                // Comparer si les ensembles de r√©ponses sont EXACTEMENT les m√™mes
                const studentSorted = studentAns.slice().sort().join(',');
                const correctSorted = correctAns.slice().sort().join(',');

                if (studentSorted === correctSorted) {
                    correctCount++;
                }
            });
            
            finalScore = correctCount;

            // Enregistrement du score uniquement si l'utilisateur est un √©l√®ve (non-visiteur)
            if (currentUser.type === 'student') {
                const newScoreRecord = {
                    id: Date.now(),
                    quizId: playingQuiz.id,
                    quizTitle: playingQuiz.title,
                    score: finalScore,
                    total: finalTotal,
                    date: new Date().toLocaleDateString('fr-FR') + ' ' + new Date().toLocaleTimeString('fr-FR'),
                    userName: currentUser.name,
                };
                studentScores.push(newScoreRecord);
                saveData('quizprof_scores', studentScores);
            }

            navigateTo('finished');
        };

        // --- INITIALISATION ---

        window.onload = () => {
            initializeData();
            setupLoginEvents();
            setupCreateQuizEvents();
        };

    </script>
</body>
</html>